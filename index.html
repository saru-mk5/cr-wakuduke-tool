<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>クリエイティブ枠付けツール (高速版)</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

<style>
    body { font-family: "Helvetica Neue", Arial, sans-serif; background: #f0f2f5; color: #333; margin: 0; padding: 20px; }
    .container { max-width: 900px; margin: 0 auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
    
    h1 { margin-top: 0; color: #0056b3; margin-bottom: 5px; }
    .desc { color: #666; margin-bottom: 25px; font-size: 0.9em; }

    /* ステップデザイン */
    .step-section { margin-bottom: 25px; padding: 20px; border: 1px solid #e1e4e8; border-radius: 8px; background: #fafbfc; }
    .step-header { font-weight: bold; font-size: 1.1em; margin-bottom: 15px; display: flex; align-items: center; color: #333; }
    .step-num { 
        background: #0056b3; color: white; width: 28px; height: 28px; border-radius: 50%; 
        display: inline-flex; justify-content: center; align-items: center; margin-right: 10px; 
        font-weight: bold; font-size: 0.9em;
    }

    /* ラジオボタン */
    .radio-group label { margin-right: 15px; cursor: pointer; background: white; padding: 5px 12px; border: 1px solid #ccc; border-radius: 4px; display: inline-block; font-size: 0.95em; }
    .radio-group input:checked + span { font-weight: bold; color: #0056b3; }

    /* プレビューエリア */
    #preview-area { text-align: center; background: #000; padding: 10px; border-radius: 4px; margin-top: 10px; min-height: 200px; display: flex; align-items: center; justify-content: center; position: relative; }
    #preview-canvas { max-width: 100%; height: auto; box-shadow: 0 0 10px rgba(0,0,0,0.5); }
    
    /* 非表示の処理用キャンバス */
    #process-canvas { display: none; }

    /* ファイルリスト */
    #file-list { list-style: none; padding: 0; margin-top: 10px; max-height: 300px; overflow-y: auto; border: 1px solid #eee; border-radius: 4px; }
    .file-item { background: white; border-bottom: 1px solid #eee; padding: 10px; display: flex; align-items: center; justify-content: space-between; gap: 10px; }
    .file-item:last-child { border-bottom: none; }
    
    .file-name-input { flex: 1; padding: 5px; border: 1px solid #ccc; border-radius: 4px; font-size: 1em; }
    .file-orig-name { font-size: 0.8em; color: #888; margin-right: 10px; max-width: 150px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

    /* ステータスバッジ */
    .status-badge { font-size: 0.8em; padding: 4px 10px; border-radius: 12px; white-space: nowrap; font-weight: bold; min-width: 60px; text-align: center; }
    .status-waiting { background: #eee; color: #666; }
    .status-processing { background: #fff3cd; color: #856404; animation: pulse 1s infinite; }
    .status-done { background: #d4edda; color: #155724; }

    /* ボタン */
    .action-area { margin-top: 30px; text-align: center; border-top: 2px solid #eee; padding-top: 20px; }
    button { cursor: pointer; transition: 0.3s; font-size: 1.1em; border: none; padding: 12px 30px; border-radius: 30px; margin: 5px; }
    
    #btn-run { background: #007bff; color: white; padding: 15px 50px; font-weight: bold; box-shadow: 0 4px 10px rgba(0,123,255,0.3); }
    #btn-run:hover { background: #0056b3; transform: translateY(-2px); }
    #btn-run:disabled { background: #ccc; cursor: not-allowed; transform: none; box-shadow: none; }

    @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.6; } 100% { opacity: 1; } }
    
    .hidden { display: none; }
    
    /* プログレス表示 */
    #progress-text { margin-top: 10px; font-weight: bold; color: #0056b3; }
</style>
</head>
<body>

<div class="container">
    <h1>クリエイティブ枠付けツール</h1>
    <p class="desc">
        選択した複数動画に、枠を一括で合成・保存することが可能です。<br>
        ※Google Chrome または Microsoft Edge で実行してください。
    </p>

    <div class="step-section">
        <div class="step-header"><span class="step-num">1</span> 設定</div>
        <div style="display:flex; gap:20px; flex-wrap:wrap;">
            <div>
                <p style="margin:0 0 5px 0; font-size:0.9em; color:#666;">アスペクト比</p>
                <div class="radio-group">
                    <label><input type="radio" name="aspect" value="16:9" checked> <span>16:9 (横動画)</span></label>
                    <label><input type="radio" name="aspect" value="9:16"> <span>9:16 (縦動画)</span></label>
                </div>
            </div>
            <div>
                <p style="margin:0 0 5px 0; font-size:0.9em; color:#666;">クリエイティブのサイズ</p>
                <div class="radio-group">
                    <label><input type="radio" name="scale" value="0.9"> <span>大 (90%)</span></label>
                    <label><input type="radio" name="scale" value="0.8" checked> <span>中 (80%)</span></label>
                    <label><input type="radio" name="scale" value="0.7"> <span>小 (70%)</span></label>
                </div>
            </div>
        </div>
    </div>

    <div class="step-section">
        <div class="step-header"><span class="step-num">2</span> 枠動画の選択とプレビュー</div>
        
        <p><strong>枠動画:</strong> <input type="file" id="inp-bg" accept="video/*"></p>
        
        <div id="preview-area">
            <canvas id="preview-canvas"></canvas>
            <div id="preview-msg" style="color:white; font-size:0.8em; position:absolute;">枠動画を選択するとプレビューが表示されます</div>
        </div>
    </div>

    <div class="step-section">
        <div class="step-header"><span class="step-num">3</span> クリエイティブ選択 (複数可)</div>
        <input type="file" id="inp-fg" accept="video/*" multiple>
        <ul id="file-list"></ul>
    </div>

    <div class="action-area">
        <button id="btn-run" disabled>素材を選択してください</button>
        <div id="progress-text"></div>
    </div>
</div>

<canvas id="process-canvas"></canvas>
<video id="vid-bg" class="hidden" muted loop playsinline></video>
<video id="vid-fg" class="hidden" muted playsinline></video>

<script>
    // UI Elements
    const inpBg = document.getElementById('inp-bg');
    const inpFg = document.getElementById('inp-fg');
    const fileListEl = document.getElementById('file-list');
    const btnRun = document.getElementById('btn-run');
    const progressText = document.getElementById('progress-text');
    
    // Preview Elements
    const previewCanvas = document.getElementById('preview-canvas');
    const previewCtx = previewCanvas.getContext('2d');
    const previewMsg = document.getElementById('preview-msg');
    
    // Processing Elements
    const processCanvas = document.getElementById('process-canvas');
    const processCtx = processCanvas.getContext('2d');
    const vidBg = document.getElementById('vid-bg');
    const vidFg = document.getElementById('vid-fg');

    // State
    let filesQueue = [];
    let config = { width: 1920, height: 1080, scale: 0.8, aspect: '16:9' };
    let isProcessing = false;
    let zip = new JSZip();

    // 1. 設定更新とプレビュー
    function updateConfig() {
        if (config.aspect === '16:9') {
            config.width = 1920; config.height = 1080;
        } else {
            config.width = 1080; config.height = 1920;
        }
        
        // プレビュー用キャンバスサイズ（表示用）
        const aspect = config.width / config.height;
        let pW = 600; let pH = pW / aspect;
        if (pH > 400) { pH = 400; pW = pH * aspect; }
        previewCanvas.width = pW; previewCanvas.height = pH;

        // 処理用キャンバスサイズ（実解像度）
        processCanvas.width = config.width;
        processCanvas.height = config.height;
    }
    updateConfig();

    function drawPreview() {
        if (!vidBg.paused && !vidBg.ended) {
            // 背景
            previewCtx.drawImage(vidBg, 0, 0, previewCanvas.width, previewCanvas.height);
            previewMsg.style.display = 'none';

            // 枠のガイド表示
            const tW = previewCanvas.width * config.scale;
            const tH = (config.aspect === '16:9') ? tW * (9/16) : tW * (16/9);
            const x = (previewCanvas.width - tW) / 2;
            const y = (previewCanvas.height - tH) / 2;

            previewCtx.strokeStyle = '#00ff00';
            previewCtx.lineWidth = 3;
            previewCtx.strokeRect(x, y, tW, tH);
            previewCtx.fillStyle = 'rgba(0, 255, 0, 0.2)';
            previewCtx.fillRect(x, y, tW, tH);
            
            previewCtx.fillStyle = 'white';
            previewCtx.font = '14px Arial';
            previewCtx.textAlign = 'center';
            previewCtx.fillText("配置エリア", previewCanvas.width/2, previewCanvas.height/2);
        }
        requestAnimationFrame(drawPreview);
    }
    drawPreview();

    // イベントリスナー
    document.querySelectorAll('input[name="aspect"]').forEach(el => el.addEventListener('change', e => {
        config.aspect = e.target.value;
        updateConfig();
    }));
    document.querySelectorAll('input[name="scale"]').forEach(el => el.addEventListener('change', e => {
        config.scale = parseFloat(e.target.value);
    }));

    inpBg.addEventListener('change', e => {
        const file = e.target.files[0];
        if(file) {
            vidBg.src = URL.createObjectURL(file);
            vidBg.play();
            checkReady();
        }
    });

    inpFg.addEventListener('change', e => {
        filesQueue = Array.from(e.target.files).map((file, i) => ({
            id: i,
            file: file,
            status: 'waiting',
            newName: file.name.replace(/\.[^/.]+$/, "")
        }));
        renderFileList();
        checkReady();
    });

    function renderFileList() {
        fileListEl.innerHTML = '';
        filesQueue.forEach((item, idx) => {
            const li = document.createElement('li');
            li.className = 'file-item';
            
            const origSpan = document.createElement('span');
            origSpan.className = 'file-orig-name';
            origSpan.innerText = item.file.name;

            const input = document.createElement('input');
            input.type = 'text';
            input.className = 'file-name-input';
            input.value = item.newName;
            input.onchange = (e) => item.newName = e.target.value;

            const badge = document.createElement('span');
            badge.className = `status-badge status-${item.status}`;
            badge.id = `badge-${idx}`;
            badge.innerText = item.status === 'waiting' ? '待機中' : '完了';

            li.appendChild(origSpan);
            li.appendChild(input);
            li.appendChild(badge);
            fileListEl.appendChild(li);
        });
    }

    function checkReady() {
        if(inpBg.files.length > 0 && filesQueue.length > 0) {
            btnRun.innerText = "一括作成を開始 (MP4)";
            btnRun.disabled = false;
        } else {
            btnRun.innerText = "素材を選択してください";
            btnRun.disabled = true;
        }
    }

    // --- 2. 処理実行 (Canvas + MediaRecorder) ---
    btnRun.onclick = async () => {
        if(isProcessing) return;
        isProcessing = true;
        btnRun.disabled = true;
        zip = new JSZip(); // ZIP初期化

        // MP4対応チェック
        let mimeType = 'video/webm';
        let ext = 'webm';
        if (MediaRecorder.isTypeSupported('video/mp4')) {
            mimeType = 'video/mp4';
            ext = 'mp4';
            console.log("MP4 Supported!");
        } else if (MediaRecorder.isTypeSupported('video/mp4; codecs=h264')) {
            mimeType = 'video/mp4; codecs=h264';
            ext = 'mp4';
            console.log("MP4 (H264) Supported!");
        } else {
            alert("お使いのブラウザはMP4録画に未対応のため、WebMで保存されます。(Chrome/Edge推奨)");
        }

        for (let i = 0; i < filesQueue.length; i++) {
            await processVideo(i, mimeType, ext);
        }

        progressText.innerText = "ZIP圧縮中...";
        const content = await zip.generateAsync({type:"blob"});
        const link = document.createElement('a');
        link.href = URL.createObjectURL(content);
        link.download = "framed_videos.zip";
        link.click();

        progressText.innerText = "完了しました！";
        alert("ダウンロードが完了しました。");
        isProcessing = false;
        btnRun.disabled = false;
    };

    function processVideo(idx, mimeType, ext) {
        return new Promise((resolve) => {
            const item = filesQueue[idx];
            document.getElementById(`badge-${idx}`).className = 'status-badge status-processing';
            document.getElementById(`badge-${idx}`).innerText = '処理中';
            progressText.innerText = `処理中: ${idx+1} / ${filesQueue.length} ...`;

            vidFg.src = URL.createObjectURL(item.file);
            
            vidFg.onloadedmetadata = () => {
                // 録画ストリーム設定
                const stream = processCanvas.captureStream(30); // 30fps
                
                // 音声トラック追加 (前面動画の音)
                // ※ブラウザによってはcaptureStreamで音声が取れない場合があるため
                // 安全策としてVideo要素から音声トラックを取得を試みる
                let audioStream;
                try {
                    audioStream = vidFg.captureStream ? vidFg.captureStream() : vidFg.mozCaptureStream();
                    if(audioStream.getAudioTracks().length > 0) {
                        stream.addTrack(audioStream.getAudioTracks()[0]);
                    }
                } catch(e) {
                    console.warn("Audio capture warning", e);
                }

                const recorder = new MediaRecorder(stream, {
                    mimeType: mimeType,
                    videoBitsPerSecond: 5000000 // 5Mbps (画質確保)
                });

                const chunks = [];
                recorder.ondataavailable = e => { if(e.data.size > 0) chunks.push(e.data); };
                
                recorder.onstop = () => {
                    const blob = new Blob(chunks, { type: mimeType });
                    zip.file(`${item.newName}.${ext}`, blob);

                    document.getElementById(`badge-${idx}`).className = 'status-badge status-done';
                    document.getElementById(`badge-${idx}`).innerText = '完了';
                    
                    vidFg.pause();
                    vidBg.pause();
                    resolve();
                };

                // 再生＆録画開始
                vidBg.currentTime = 0;
                vidFg.currentTime = 0;
                vidBg.play();
                vidFg.play();
                recorder.start();

                // 描画ループ
                const draw = () => {
                    if (vidFg.paused || vidFg.ended) {
                        if (recorder.state === 'recording') recorder.stop();
                        return;
                    }

                    // 背景
                    processCtx.drawImage(vidBg, 0, 0, config.width, config.height);

                    // 前面 (アスペクト比維持で枠内に収める)
                    const tW = config.width * config.scale;
                    const fgAspect = vidFg.videoWidth / vidFg.videoHeight;
                    
                    // 枠のアスペクト比に合わせて計算
                    // (枠自体のアスペクト比は動画のアスペクト比に依存させるか、設定に依存させるか)
                    // ここでは設定のアスペクト比(16:9 or 9:16)のボックス内に収める
                    const boxW = tW;
                    const boxH = (config.aspect === '16:9') ? boxW * (9/16) : boxW * (16/9);

                    // 実際に描画するサイズ (contain)
                    let drawW = boxW;
                    let drawH = drawW / fgAspect;

                    if (drawH > boxH) {
                        drawH = boxH;
                        drawW = drawH * fgAspect;
                    }

                    const x = (config.width - drawW) / 2;
                    const y = (config.height - drawH) / 2;

                    processCtx.drawImage(vidFg, x, y, drawW, drawH);

                    if (recorder.state === 'recording') {
                        requestAnimationFrame(draw);
                    }
                };
                draw();
            };
        });
    }
</script>
</body>
</html>
