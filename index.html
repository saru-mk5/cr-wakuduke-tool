<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>クリエイティブ枠付けツール</title>
<link rel="icon" href="./favicon.png" type="image/png">

<script src="coi-serviceworker.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@ffmpeg/ffmpeg@0.11.6/dist/ffmpeg.min.js"></script>

<style>
    body { font-family: "Helvetica Neue", Arial, sans-serif; background: #f0f2f5; color: #333; margin: 0; padding: 20px; }
    .container { max-width: 900px; margin: 0 auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
    h1 { margin-top: 0; color: #0056b3; margin-bottom: 5px; }
    .desc { color: #666; margin-bottom: 25px; font-size: 0.9em; }
    .step-section { margin-bottom: 25px; padding: 20px; border: 1px solid #e1e4e8; border-radius: 8px; background: #fafbfc; }
    .step-header { font-weight: bold; font-size: 1.1em; margin-bottom: 15px; display: flex; align-items: center; color: #333; }
    .step-num { background: #0056b3; color: white; width: 28px; height: 28px; border-radius: 50%; display: inline-flex; justify-content: center; align-items: center; margin-right: 10px; font-weight: bold; font-size: 0.9em; }
    .radio-group label { margin-right: 15px; cursor: pointer; background: white; padding: 5px 12px; border: 1px solid #ccc; border-radius: 4px; display: inline-block; font-size: 0.95em; }
    .radio-group input:checked + span { font-weight: bold; color: #0056b3; }
    #preview-area { text-align: center; background: #000; padding: 10px; border-radius: 4px; margin-top: 10px; min-height: 200px; display: flex; align-items: center; justify-content: center; }
    canvas { max-width: 100%; height: auto; box-shadow: 0 0 10px rgba(0,0,0,0.5); }
    #file-list { list-style: none; padding: 0; margin-top: 10px; max-height: 300px; overflow-y: auto; border: 1px solid #eee; border-radius: 4px; }
    .file-item { background: white; border-bottom: 1px solid #eee; padding: 10px; display: flex; align-items: center; justify-content: space-between; gap: 10px; }
    .file-item:last-child { border-bottom: none; }
    .file-name-input { flex: 1; padding: 5px; border: 1px solid #ccc; border-radius: 4px; font-size: 1em; }
    .file-orig-name { font-size: 0.8em; color: #888; margin-right: 10px; max-width: 150px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .status-badge { font-size: 0.8em; padding: 4px 10px; border-radius: 12px; white-space: nowrap; font-weight: bold; min-width: 60px; text-align: center; }
    .status-waiting { background: #eee; color: #666; }
    .status-processing { background: #fff3cd; color: #856404; animation: pulse 1s infinite; }
    .status-done { background: #d4edda; color: #155724; }
    .status-error { background: #f8d7da; color: #721c24; }
    .action-area { margin-top: 30px; text-align: center; border-top: 2px solid #eee; padding-top: 20px; }
    button { cursor: pointer; transition: 0.3s; font-size: 1.1em; border: none; padding: 12px 30px; border-radius: 30px; margin: 5px; }
    #btn-run { background: #007bff; color: white; padding: 15px 50px; font-weight: bold; box-shadow: 0 4px 10px rgba(0,123,255,0.3); }
    #btn-run:hover { background: #0056b3; transform: translateY(-2px); }
    #btn-run:disabled { background: #ccc; cursor: not-allowed; transform: none; box-shadow: none; }
    @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.6; } 100% { opacity: 1; } }
    .hidden { display: none; }
    
    /* 診断メッセージ用 */
    #diag-msg { padding: 10px; margin-bottom: 20px; border-radius: 5px; display: none; }
    .diag-error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
    .diag-ok { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
    #console-log { background: #333; color: #0f0; padding: 10px; font-family: monospace; font-size: 0.8em; height: 100px; overflow-y: scroll; margin-top: 20px; text-align: left; border-radius: 5px; display: none;}
</style>
</head>
<body>

<div class="container">
    <h1>クリエイティブ枠付けツール</h1>
    <div id="diag-msg"></div>
    <p class="desc">背景（枠動画）の指定し、枠を付けたい動画と合成～保存ができます。<br>
※書き出しに時間がかかりますが、別の作業をしていても進行可能です。</p>

    <div class="step-section">
        <div class="step-header"><span class="step-num">1</span> 設定</div>
        <div style="display:flex; gap:20px; flex-wrap:wrap;">
            <div>
                <p style="margin:0 0 5px 0; font-size:0.9em; color:#666;">アスペクト比</p>
                <div class="radio-group">
                    <label><input type="radio" name="aspect" value="16:9" checked> <span>16:9 (横動画)</span></label>
                    <label><input type="radio" name="aspect" value="9:16"> <span>9:16 (縦動画)</span></label>
                </div>
            </div>
            <div>
                <p style="margin:0 0 5px 0; font-size:0.9em; color:#666;">サイズ (デフォルト:中)</p>
                <div class="radio-group">
                    <label><input type="radio" name="scale" value="0.9"> <span>大 (90%)</span></label>
                    <label><input type="radio" name="scale" value="0.8" checked> <span>中 (80%)</span></label>
                    <label><input type="radio" name="scale" value="0.7"> <span>小 (70%)</span></label>
                </div>
            </div>
        </div>
    </div>

    <div class="step-section">
        <div class="step-header"><span class="step-num">2</span> 枠動画の選択とプレビュー</div>
        <p><strong>枠動画:</strong> <input type="file" id="inp-bg" accept="video/*"></p>
        <div id="preview-area">
            <canvas id="preview-canvas"></canvas>
            <div id="preview-msg" style="color:white; font-size:0.8em;">枠動画を選択するとプレビューが表示されます</div>
        </div>
    </div>

    <div class="step-section">
        <div class="step-header"><span class="step-num">3</span> クリエイティブ選択 (複数可)</div>
        <input type="file" id="inp-fg" accept="video/*" multiple>
        <ul id="file-list"></ul>
    </div>

    <div class="action-area">
        <button id="btn-run" disabled>エンジンの準備中...</button>
        <div id="console-log"></div>
    </div>
</div>

<video id="vid-bg" class="hidden" muted loop playsinline></video>

<script>
    const { createFFmpeg, fetchFile } = FFmpeg;
    const ffmpeg = createFFmpeg({ 
        log: true, 
        corePath: 'https://cdn.jsdelivr.net/npm/@ffmpeg/core@0.11.0/dist/ffmpeg-core.js' 
    });

    const inpBg = document.getElementById('inp-bg');
    const inpFg = document.getElementById('inp-fg');
    const fileListEl = document.getElementById('file-list');
    const btnRun = document.getElementById('btn-run');
    const vidBg = document.getElementById('vid-bg');
    const canvas = document.getElementById('preview-canvas');
    const ctx = canvas.getContext('2d');
    const previewMsg = document.getElementById('preview-msg');
    const diagMsg = document.getElementById('diag-msg');
    const consoleLog = document.getElementById('console-log');

    let filesQueue = [];
    // メモリ不足対策: デフォルト解像度を720pに下げる (1280x720)
    let config = { width: 1280, height: 720, scale: 0.8, aspect: '16:9' };
    let isFfmpegReady = false;

    // ログ出力関数
    function log(msg) {
        consoleLog.style.display = 'block';
        consoleLog.innerText += msg + "\n";
        consoleLog.scrollTop = consoleLog.scrollHeight;
        console.log(msg);
    }

    // 0. 起動診断
    function checkEnvironment() {
        if (!window.crossOriginIsolated) {
            diagMsg.style.display = 'block';
            diagMsg.className = 'diag-error';
            diagMsg.innerHTML = `
                <strong>⚠️ 設定エラー:</strong><br>
                「coi-serviceworker.js」が正しく読み込まれていません。<br>
                1. <code>coi-serviceworker.js</code> が <code>index.html</code> と同じ場所にありますか？<br>
                2. ページを一度リロード（再読み込み）してください。
            `;
            return false;
        }
        return true;
    }

    // 1. FFmpeg 初期化
    async function initFFmpeg() {
        if (!checkEnvironment()) {
            btnRun.innerText = "設定エラー";
            return;
        }
        try {
            log("FFmpegをロード中...");
            await ffmpeg.load();
            isFfmpegReady = true;
            log("FFmpegロード完了。準備OK。");
            checkReady();
        } catch (e) {
            log("エラー: FFmpegのロードに失敗しました");
            alert("エンジンのロードに失敗しました。GitHub Pagesの設定を確認してください。");
            console.error(e);
        }
    }
    initFFmpeg();

    // 2. プレビュー & 設定
    function updateConfig() {
        if (config.aspect === '16:9') {
            config.width = 1280; config.height = 720; // 720pに統一
        } else {
            config.width = 720; config.height = 1280;
        }
        const aspect = config.width / config.height;
        let pW = 600; let pH = pW / aspect;
        if (pH > 400) { pH = 400; pW = pH * aspect; }
        canvas.width = pW; canvas.height = pH;
    }
    updateConfig();

    function drawPreview() {
        if (vidBg.paused && vidBg.readyState >= 2) vidBg.play();
        if (vidBg.readyState >= 2) {
            ctx.drawImage(vidBg, 0, 0, canvas.width, canvas.height);
            previewMsg.style.display = 'none';
        } else {
            ctx.fillStyle = '#333';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
        }
        const tW = canvas.width * config.scale;
        const tH = (config.aspect === '16:9') ? tW * (9/16) : tW * (16/9); 
        const x = (canvas.width - tW) / 2;
        const y = (canvas.height - tH) / 2;
        ctx.strokeStyle = '#00ff00';
        ctx.lineWidth = 4;
        ctx.strokeRect(x, y, tW, tH);
        ctx.fillStyle = 'rgba(0, 255, 0, 0.2)';
        ctx.fillRect(x, y, tW, tH);
        requestAnimationFrame(drawPreview);
    }
    drawPreview();

    document.querySelectorAll('input[name="aspect"]').forEach(el => el.addEventListener('change', e => {
        config.aspect = e.target.value;
        updateConfig();
    }));
    document.querySelectorAll('input[name="scale"]').forEach(el => el.addEventListener('change', e => {
        config.scale = parseFloat(e.target.value);
    }));

    inpBg.addEventListener('change', e => {
        const file = e.target.files[0];
        if(file) { vidBg.src = URL.createObjectURL(file); checkReady(); }
    });

    inpFg.addEventListener('change', e => {
        filesQueue = Array.from(e.target.files).map((file, i) => ({
            id: i, file: file, status: 'waiting', newName: file.name.replace(/\.[^/.]+$/, "")
        }));
        renderFileList();
        checkReady();
    });

    function renderFileList() {
        fileListEl.innerHTML = '';
        filesQueue.forEach((item, idx) => {
            const li = document.createElement('li');
            li.className = 'file-item';
            li.innerHTML = `
                <span class="file-orig-name">${item.file.name}</span>
                <input type="text" class="file-name-input" value="${item.newName}" onchange="updateName(${idx}, this.value)">
                <span class="status-badge status-${item.status}" id="badge-${idx}">${getStatusText(item.status)}</span>
            `;
            fileListEl.appendChild(li);
        });
    }
    window.updateName = (idx, val) => { filesQueue[idx].newName = val; };
    function getStatusText(s) { return s==='waiting'?'待機': s==='processing'?'処理中': s==='saving'?'保存中': s==='done'?'完了': 'エラー'; }
    function updateStatus(idx, s) { 
        filesQueue[idx].status = s; 
        const b = document.getElementById(`badge-${idx}`);
        if(b) { b.className = `status-badge status-${s}`; b.innerText = getStatusText(s); }
    }

    function checkReady() {
        if(isFfmpegReady && inpBg.files.length > 0 && filesQueue.length > 0) {
            btnRun.innerText = "一括作成を開始";
            btnRun.disabled = false;
        } else {
            if(!isFfmpegReady) btnRun.innerText = "エンジンの準備中...";
            else btnRun.innerText = "素材を選択してください";
            btnRun.disabled = true;
        }
    }

    btnRun.onclick = async () => {
        btnRun.disabled = true;
        const bgFile = inpBg.files[0];
        try {
            log("背景動画を読み込み中...");
            ffmpeg.FS('writeFile', 'bg.mp4', await fetchFile(bgFile));

            for (let i = 0; i < filesQueue.length; i++) {
                const item = filesQueue[i];
                updateStatus(i, 'processing');
                log(`[${i+1}/${filesQueue.length}] ${item.file.name} の処理を開始...`);

                ffmpeg.FS('writeFile', 'input.mp4', await fetchFile(item.file));
                const outName = `output.mp4`;
                
                // コマンド実行
                log("エンコード中... (数分かかる場合があります)");
                await ffmpeg.run(
                    '-stream_loop', '-1', '-i', 'bg.mp4', '-i', 'input.mp4', 
                    '-filter_complex', `[1:v]scale=iw*${config.scale}:-1[fg];[0:v][fg]overlay=(W-w)/2:(H-h)/2:shortest=1`,
                    '-c:v', 'libx264', '-preset', 'ultrafast', '-c:a', 'aac', 
                    outName
                );

                updateStatus(i, 'saving');
                log("書き出し中...");
                const data = ffmpeg.FS('readFile', outName);
                const blob = new Blob([data.buffer], { type: 'video/mp4' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${item.newName}.mp4`;
                document.body.appendChild(a);
                a.click();
                setTimeout(() => { document.body.removeChild(a); URL.revokeObjectURL(url); }, 2000);

                ffmpeg.FS('unlink', 'input.mp4');
                ffmpeg.FS('unlink', outName);
                updateStatus(i, 'done');
                log("完了！");
            }
            ffmpeg.FS('unlink', 'bg.mp4');
            alert("すべての処理が完了しました！");
        } catch (err) {
            console.error(err);
            log("エラーが発生しました: " + err.message);
            alert("エラーが発生しました。処理を中断します。");
        }
        btnRun.disabled = false;
    };
</script>
</body>
</html>

